<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bitcamp.java93.dao.NotificationDao">
  
  <resultMap type="notification" id="notificationMap">
    <id column="notino" property="no"/>
    <result column="type" property="type"/>
    <result column="date" property="date"/>
    <result column="cont" property="contents"/>
    <result column="whom" property="whom"/>
    <association property="musician" javaType='Musician'>
      <id property="no" column="musino"/>
    <result property="nickName" column="nick"/>
    <result property="photo" column="musiphoto"/>
    </association>
    <association property="writer" javaType='Member'>
      <id property="no" column="gmno"/>
    <result property="name" column="gmname"/>
    <result property="photo" column="gmphoto"/>
    </association>
    <association property="event" javaType='Event'>
      <id property="no" column="eno"/>
    <result property="title" column="title"/>
    </association>
  </resultMap>

 <select id="selectNotiList" resultMap="notificationMap" parameterType="int">
  select  notino, n.type, n.date, n.cont, n.whom, n.eno, e.title, 
  gm.mno as gmno, gm.name as gmname, gm.path as gmphoto, 
  n.muno as musino, mu.nick, m.path as musiphoto
from noti n
inner join memb m on n.muno=m.mno inner join musi mu on m.mno=mu.muno
inner join evn e on n.eno=e.eno inner join memb gm on e.mno=gm.mno
where gm.mno=#{no} and (n.whom='gmember' or n.whom='both')
order by date desc
  </select><!-- 완진 -->
  
  <select id="selectMusiNotiList" resultMap="notificationMap" parameterType="int">
  select  notino, n.type, n.date, n.cont, n.whom, n.eno, e.title, 
  gm.mno as gmno, gm.name as gmname, gm.path as gmphoto, 
  n.muno as musino, mu.nick, m.path as musiphoto
from noti n
inner join memb m on n.muno=m.mno inner join musi mu on m.mno=mu.muno
inner join evn e on n.eno=e.eno inner join memb gm on e.mno=gm.mno
where n.muno=#{no} and (n.whom='musician' or n.whom='both')
order by date desc
  </select><!-- 완진 -->
  
   <!-- 뮤지션에게 일반인이 pr -->
  <insert id="insertEventPrNoti" parameterType="map">
    insert into noti(muno, eno, type, date, cont, whom, prno) 
    values(#{muNo}, #{eNo}, 'pr', CURDATE(), '제안받은 이벤트', 'musician', #{prNo})
  </insert><!-- 승민 -->
  
  <!-- 일반인에게 뮤지션이 appy -->
  <insert id="insertEventAppyNoti" parameterType="map">
    insert into noti(muno, eno, type, date, cont, whom, appyno) 
    values(#{muNo}, #{eNo}, 'appy', CURDATE(), '이벤트 지원', 'gmember', #{appyno})
  </insert><!-- 승민 -->
  
  <!-- 뮤지션에게 이벤트 편집 -->
  <insert id="insertEventEditNoti" parameterType="map">
    insert into noti(muno, eno, type, date, cont, whom, appyno) 
    values(#{muNo}, #{eNo}, 'evn_edit', CURDATE(), '이벤트 편집', 'musician', (select appyno from appy where eno=#{eNo} and muno=#{muNo}))
  </insert><!-- 승민 -->
  
  <!-- 뮤지션에게 이벤트 삭제 -->
  <insert id="insertEventDeleteNoti" parameterType="map">
    insert into noti(muno, eno, type, date, cont, whom, appyno) 
    values(#{muNo}, #{eNo}, 'evn_delete', CURDATE(), '이벤트 삭제', 'musician' , (select appyno from appy where eno=#{eNo} and muno=#{muNo}))
  </insert><!-- 승민 -->
  
  
</mapper>












